#!/bin/bash

# Get the root directory of the Git repository
REPO_ROOT=$(git rev-parse --show-toplevel)
if [ $? -ne 0 ]; then
  echo "Error: Not in a Git repository."
  exit 1
fi

# Move to the root directory
cd "$REPO_ROOT" || exit

# Check if nx is installed
if ! command -v nx &> /dev/null; then
  echo "Error: 'nx' command not found."
  echo "Please install it globally with one of the following commands:"
  echo "  npm install -g nx"
  echo "  yarn global add nx"
  exit 1
fi

# Get the list of changed files (staged for commit)
CHANGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.ts\|\.js\|\.jsx\|\.tsx')

if [ -z "$CHANGED_FILES" ]; then
  echo "No JavaScript/TypeScript files changed. Skipping lint."
  exit 0
fi

# Run Nx lint only on the changed files
echo "Running lint on the following files:"
echo "$CHANGED_FILES"

# Run Nx lint on each file individually
nx lint --fix --silent --files="$CHANGED_FILES"
LINT_EXIT_CODE=$?

# Check if the linter was able to fix all errors
if [ $LINT_EXIT_CODE -ne 0 ]; then
  echo "Linting failed. Please fix the issues and try again."
  
  # Show the remaining errors for the changed files
  nx lint --files="$CHANGED_FILES"
  
  # Abort the commit
  exit 1
fi

# Stage the changes that were auto-fixed
echo "Auto-fix applied. Staging changes..."
git add $(git diff --name-only)

# Allow commit to proceed
exit 0

